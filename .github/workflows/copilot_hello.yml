name: Copilot Agent Hello World

on:
  workflow_dispatch:  # run manually for testing

permissions:
  contents: read
  issues: write

jobs:
  hello-agent:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_GITHUB }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PAT exists
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "âŒ No GH_TOKEN found â€” maybe you didnâ€™t create the PAT_GITHUB secret yet?"
            echo "ðŸ‘‰ Go to: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret â†’ Name: PAT_GITHUB"
            exit 1
          else
            echo "âœ… GH_TOKEN detected, continuing..."
          fi

      - name: Install latest GitHub CLI and Copilot extension
        run: |
          echo "Installing latest GitHub CLI..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq gh
          echo "Installing Copilot extension..."
          gh extension install github/gh-copilot || gh extension upgrade github/gh-copilot

      - name: Verify token works
        run: |
          if ! gh auth status > /dev/null 2>&1; then
            echo "âš ï¸ GitHub CLI not yet authenticated â€” trying login..."
            echo "$GH_TOKEN" | gh auth login --with-token || {
              echo "âŒ Authentication failed â€” check your PAT_GITHUB scopes or validity."
              exit 1
            }
          else
            echo "âœ… GitHub CLI already authenticated."
          fi          

      - name: Verify authentication
        run: |
          gh auth status || echo "âš ï¸ Authentication check failed"

      - name: List Copilot CLI capabilities
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          set -e
          echo "== gh version =="
          gh --version
          echo
          echo "== installed extensions =="
          gh extension list || true
          echo
          echo "== gh copilot --help (top) =="
          gh copilot --help || true
          echo
          echo "== subcommands slice =="
          gh copilot --help | sed -n '/Available Commands:/,/Flags:/p' || true
          echo
          echo "== all help entries mentioning copilot =="
          gh help -a | sed -n '/copilot/p' || true

      - name: Test Copilot reasoning ability
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo '{
            "body": "Please add mrs to bdk project",
            "sender": "Michael Ringholm Sundgaard"
          }' > issue.json

          echo "ðŸ§  Asking Copilot to rephrase the issue..."
          gh copilot suggest -p "You are an issue-formatting assistant. Read this JSON and output a human-friendly issue title and markdown body:\n$(cat issue.json)"

      - name: Call Copilot Agent
        run: |
          echo "ðŸ§  Testing Copilot Agent connectivity..."
          gh copilot agent create \
            --name "Hello-Test-Agent" \
            --instructions "You are a helpful assistant. Reply with 'pong' when you receive 'ping'." \
            --input "ping" \
            --debug
