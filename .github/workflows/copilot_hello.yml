name: Copilot Agent Hello World

on:
  workflow_dispatch:  # run manually for testing

permissions:
  contents: read
  issues: write

jobs:
  hello-agent:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_GITHUB }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PAT exists
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "‚ùå No GH_TOKEN found ‚Äî maybe you didn‚Äôt create the PAT_GITHUB secret yet?"
            echo "üëâ Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret ‚Üí Name: PAT_GITHUB"
            exit 1
          else
            echo "‚úÖ GH_TOKEN detected, continuing..."
          fi

      - name: Install latest GitHub CLI and Copilot extension
        run: |
          echo "Installing latest GitHub CLI..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq gh
          echo "Installing Copilot extension..."
          gh extension install github/gh-copilot || gh extension upgrade github/gh-copilot

      - name: Verify token works
        run: |
          if ! gh auth status > /dev/null 2>&1; then
            echo "‚ö†Ô∏è GitHub CLI not yet authenticated ‚Äî trying login..."
            echo "$GH_TOKEN" | gh auth login --with-token || {
              echo "‚ùå Authentication failed ‚Äî check your PAT_GITHUB scopes or validity."
              exit 1
            }
          else
            echo "‚úÖ GitHub CLI already authenticated."
          fi          

      - name: Verify authentication
        run: |
          gh auth status || echo "‚ö†Ô∏è Authentication check failed"

      - name: Call Copilot Agent
        run: |
          echo "üß† Testing Copilot Agent connectivity..."
          gh copilot agent create \
            --name "Hello-Test-Agent" \
            --instructions "You are a helpful assistant. Reply with 'pong' when you receive 'ping'." \
            --input "ping" \
            --debug
