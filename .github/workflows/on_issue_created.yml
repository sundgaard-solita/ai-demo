name: Process New Issue with Copilot Agent

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  process-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Save issue body
        run: |
          cat << 'EOF' > issue_body.txt
          ${{ github.event.issue.body }}
          EOF
          echo "Original issue body saved"
          cat issue_body.txt
      
      - name: Call Copilot Chat API to process content
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create request for Copilot to process the issue
          ISSUE_BODY="$(cat issue_body.txt)"
          
          # Build the prompt based on instructions.md context
          PROMPT="You are an AI agent that helps automate work for IT employees at Solita Denmark. 
          Your role is to convert rough input (which may be JSON, XML, YAML, or unformatted text from sources like MS Teams) 
          into clean, human-readable markdown format.
          
          Please process the following issue content and extract:
          1. A clear, descriptive title
          2. A well-formatted description in markdown
          3. Any action items or tasks that should be carried out
          
          Return your response as JSON with the following structure:
          {
            \"title\": \"<descriptive title>\",
            \"description\": \"<markdown formatted description>\",
            \"actions\": [\"<action item 1>\", \"<action item 2>\"]
          }
          
          Original issue content to process:
          $ISSUE_BODY"
          
          # Create request JSON
          jq -n \
            --arg prompt "$PROMPT" \
            '{ 
              model: "gpt-4o", 
              messages: [
                {
                  role: "user", 
                  content: $prompt
                }
              ]
            }' > request.json
          
          echo "Sending request to Copilot API..."
          
          # Call Copilot Chat API
          gh api --method POST \
            -H "Content-Type: application/json" \
            /copilot/chat/completions \
            --input request.json > response.json || {
              echo "Failed to call Copilot API"
              cat response.json
              exit 1
            }
          
          echo "Response received:"
          cat response.json
          
          # Extract the content
          jq -r '.choices[0].message.content // empty' response.json > processed.txt
          
          if [ ! -s processed.txt ]; then
            echo "No content returned from Copilot"
            exit 1
          fi
          
          echo "Processed content:"
          cat processed.txt
      
      - name: Update issue with processed content
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROCESSED_CONTENT="$(cat processed.txt)"

          # Try to parse as JSON and extract title and description
          TITLE=$(echo "$PROCESSED_CONTENT" | jq -r '.title // empty' 2>/dev/null)
          DESC=$(echo "$PROCESSED_CONTENT" | jq -r '.description // empty' 2>/dev/null)
          ACTIONS=$(echo "$PROCESSED_CONTENT" | jq -r '.actions // empty' 2>/dev/null)

          # If JSON parsing failed, use the content as description
          if [ -z "$DESC" ]; then
            DESC="$PROCESSED_CONTENT"
          fi

          # Build the full description with actions if any
          if [ -n "$ACTIONS" ] && [ "$ACTIONS" != "null" ] && [ "$ACTIONS" != "[]" ]; then
            # Convert actions array to bullet list
            ACTION_LIST=$(echo "$ACTIONS" | jq -r '.[] | "- " + .' 2>/dev/null)
            if [ -n "$ACTION_LIST" ]; then
              DESC="${DESC}"$'\n\n'"## Action Items"$'\n'"${ACTION_LIST}"
            fi
          fi

          # Update issue - only update title if we got one
          if [ -n "$TITLE" ] && [ "$TITLE" != "null" ]; then
            gh api --method PATCH \
              repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -f title="$TITLE" \
              -f body="$DESC"
          else
            # Just update the body
            gh api --method PATCH \
              repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -f body="$DESC"
          fi

          echo "âœ… Issue updated successfully"
