name: On New Issue
on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  reason:
    runs-on: ubuntu-latest
    steps:
      - name: Save issue body safely
        run: |
          echo '${{ toJson(github.event.issue.body) }}' > issue_body.txt
          echo "✅ Saved body to issue_body.txt"

      - name: Build Copilot request
        run: |
          PROMPT="Rewrite the following Teams-originated message into a clean, human-readable GitHub issue. Extract intent, clarify request, and propose a descriptive title. Output JSON with keys: title, description."
          ISSUE_BODY="$(cat issue_body.txt)"
          jq -n \
            --arg prompt "$PROMPT" \
            --arg body "$ISSUE_BODY" \
            '{ model:"gpt-4o-mini", messages:[ {role:"user", content: ($prompt + "\n\n" + $body)} ] }' \
            > req.json
          cat req.json

      - name: Debug Copilot API availability
        run: |
          echo "Testing Copilot agent endpoints..."
          gh api /copilot || echo "❌ /copilot root not visible"
          gh api /copilot/agents || echo "❌ /copilot/agents not visible"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Call Copilot Chat API via gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # POST to Copilot chat completions using gh api
          RESP=$(gh api --method POST \
            -H "content-type: application/json" \
            /copilot/chat/completions \
            --input req.json)

          echo "$RESP" | tee resp.json
          # Try to extract model output
          TEXT=$(jq -r '.choices[0].message.content // empty' resp.json)
          if [ -z "$TEXT" ] || [ "$TEXT" = "null" ]; then
            TEXT="(Copilot returned empty or unexpected response)\n\n\`\`\`json\n$(cat resp.json)\n\`\`\`"
          fi
          printf "%s" "$TEXT" > refined.txt

      - name: Update issue with refined content
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE=$(jq -r 'try (fromjson | .title) catch empty' refined.txt)
          DESC=$(jq -r 'try (fromjson | .description) catch empty' refined.txt)
          # If not valid JSON, treat whole text as description
          if [ -z "$DESC" ]; then
            DESC="$(cat refined.txt)"
          fi
          # Fallback title if missing
          if [ -z "$TITLE" ]; then
            TITLE="Refined issue"
          fi

          # Patch issue
          gh api --method PATCH \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -f title="$TITLE" \
            -f body="$DESC"
