name: Process New Issue with Copilot Agent

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read
  models: read

jobs:
  process-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Save issue body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Save issue body from environment variable to avoid code injection
          printf '%s' "$ISSUE_BODY" > issue_body.txt
          echo "Original issue body saved"
          cat issue_body.txt
      
      - name: Call GitHub Models API to process content
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Read the issue body
          ISSUE_BODY="$(cat issue_body.txt)"

          # Build the prompt based on instructions.md context
          PROMPT='You are an AI agent that helps automate work for IT employees at Solita Denmark.
          Your role is to convert rough input (which may be JSON, XML, YAML, or unformatted text from sources like MS Teams)
          into clean, human-readable markdown format.

          Please process the following issue content and extract:
          1. A clear, descriptive title
          2. A well-formatted description in markdown
          3. Any action items or tasks that should be carried out

          Return your response as JSON with the following structure:
          {
            "title": "<descriptive title>",
            "description": "<markdown formatted description>",
            "actions": ["<action item 1>", "<action item 2>"]
          }

          Original issue content to process:
          '"${ISSUE_BODY}"
          
          # Create request JSON using the correct API format
          # The endpoint expects: input field with the prompt text
          jq -n \
            --arg input "$PROMPT" \
            '{
              input: $input,
              parameters: {
                temperature: 0.3,
                max_tokens: 2000
              }
            }' > request.json
          
          echo "Request payload:"
          jq '.' request.json
          echo
          
          ORG="${{ github.repository_owner }}"
          MODEL="gpt-4o"
          ENDPOINT="https://api.github.com/orgs/$ORG/copilot/models/openai/$MODEL/inference"
          
          echo "Calling GitHub Copilot Models API..."
          echo "Endpoint: $ENDPOINT"
          echo
          
          # Call GitHub Copilot Models API with proper error handling
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json \
            -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            "$ENDPOINT" \
            --data @request.json)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response:"
          cat response.json
          echo
          
          # Check for errors
          if [[ ! "$HTTP_CODE" =~ ^2 ]]; then
            echo "❌ GitHub Copilot Models API call failed (HTTP $HTTP_CODE)"
            echo
            echo "Troubleshooting:"
            if [[ "$HTTP_CODE" == "404" ]]; then
              echo "• The Copilot Models API endpoint was not found (404)"
              echo "• Possible causes:"
              echo "  1. GitHub Copilot may not be enabled for the organization '$ORG'"
              echo "  2. The repository may not have access to Copilot Models"
              echo "  3. The API endpoint may have changed"
              echo
              echo "• To fix this:"
              echo "  1. Ensure GitHub Copilot is enabled for your organization"
              echo "  2. Check that the repository has 'models: read' permission in workflow settings"
              echo "  3. Verify your organization has access to GitHub Models"
            elif [[ "$HTTP_CODE" == "403" ]]; then
              echo "• Access forbidden (403) - check permissions"
              echo "• Ensure the workflow has 'models: read' permission"
            else
              echo "• Unexpected error occurred"
              echo "• Check the response above for details"
            fi
            exit 1
          fi
          
          # Extract the response content
          # The response format should have the output in a specific field
          jq -r '.output // .text // .choices[0].message.content // empty' response.json > processed.txt
          
          if [ ! -s processed.txt ]; then
            echo "⚠️  No content extracted from API response"
            echo "Response may have unexpected format. Trying to use full response as content..."
            cat response.json > processed.txt
          fi
          
          echo "✅ Processed content:"
          cat processed.txt
      
      - name: Update issue with processed content
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROCESSED_CONTENT="$(cat processed.txt)"

          # Try to parse as JSON and extract all fields
          echo "Attempting to parse JSON response..."
          TITLE=$(echo "$PROCESSED_CONTENT" | jq -r '.title // empty')
          TITLE_EXIT=$?

          if [ $TITLE_EXIT -ne 0 ]; then
            echo "⚠️  JSON parsing failed, using raw content as description"
            TITLE=""
            DESC="$PROCESSED_CONTENT"
            ACTIONS=""
          else
            # Parse succeeded, get other fields
            DESC=$(echo "$PROCESSED_CONTENT" | jq -r '.description // empty')
            ACTIONS=$(echo "$PROCESSED_CONTENT" | jq -r '.actions // empty')
          fi

          # If description is empty, use the full content
          if [ -z "$DESC" ]; then
            echo "Description is empty, using full content"
            DESC="$PROCESSED_CONTENT"
          fi

          # Build the full description with actions if any
          if [ -n "$ACTIONS" ] && [ "$ACTIONS" != "null" ] && [ "$ACTIONS" != "[]" ]; then
            # Convert actions array to bullet list with tostring for safety
            ACTION_LIST=$(echo "$ACTIONS" | jq -r '.[] | "- " + (. | tostring)')
            ACTION_EXIT=$?
            if [ $ACTION_EXIT -eq 0 ] && [ -n "$ACTION_LIST" ]; then
              DESC="${DESC}"$'\n\n'"## Action Items"$'\n'"${ACTION_LIST}"
              echo "✅ Added action items to description"
            else
              echo "⚠️  Could not parse actions array, skipping action items"
            fi
          fi

          # Update issue - only update title if we got one
          if [ -n "$TITLE" ] && [ "$TITLE" != "null" ]; then
            echo "Updating issue with title and description..."
            gh api --method PATCH \
              repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -f title="$TITLE" \
              -f body="$DESC"
          else
            echo "Updating issue with description only..."
            # Just update the body
            gh api --method PATCH \
              repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -f body="$DESC"
          fi

          echo "✅ Issue updated successfully"
