name: On New Issue
on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read
  copilot: read

jobs:
  reason:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§  Ask Copilot to rewrite the issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          PROMPT="Rewrite the following Teams-originated message into a clean, human-readable GitHub issue. Extract intent, clarify request, and propose a descriptive title. Output JSON with keys: title, description."

          # Call GitHub's internal Copilot reasoning API
          RESP=$(gh api copilot/chat/completions \
            -f model=gpt-4o-mini \
            -f messages="[{'role':'user','content':'$PROMPT\n\n$ISSUE_BODY'}]" \
            | jq -r '.choices[0].message.content')

          echo "Copilot response:"
          echo "$RESP"

          # Try to parse the JSON Copilot produced
          TITLE=$(echo "$RESP" | jq -r '.title // empty' 2>/dev/null || true)
          DESC=$(echo "$RESP" | jq -r '.description // .summary // empty' 2>/dev/null || true)

          # Fallback: if Copilot replied in plain text, use that as description
          if [ -z "$DESC" ]; then
            DESC="$RESP"
          fi

          echo "TITLE: $TITLE"
          echo "DESC length: $(printf "%s" "$DESC" | wc -c)"

          # Update the issue directly in this repo
          gh api \
            --method PATCH \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -f title="${TITLE:-Refined issue}" \
            -f body="$DESC"
